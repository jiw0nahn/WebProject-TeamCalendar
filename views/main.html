{% extends 'layout.html' %}

{% block content %}
    <div class="calendar-wrap">
        <div class="team-selector">
            <select id="team-select" class="input-group" onchange="location.href='/?teamId=' + this.value">
                <option value="">ğŸŸ¦ ë‚´ ì „ì²´ ì¼ì • ë³´ê¸°</option>
                {% for team in teams %}
                <option value="{{team.id}}" {% if currentTeam and currentTeam.id == team.id %}selected{% endif %}>
                    {{team.name}}
                </option>
                {% endfor %}
            </select>
        </div>

        <div id="calendar"></div>
    </div>

    <div class="team-info-wrap">
        <div class="team-memo">
            <h2>{% if currentTeam %}{{currentTeam.name}} ë©”ëª¨{% else %}íŒ€ ë©”ëª¨{% endif %}</h2>
            {% if currentTeam %}
                <form action="/team/{{currentTeam.id}}/memo" method="post" class="memo-form">
                    <textarea name="memo" placeholder="ì´ íŒ€ì—ì„œ ê¸°ì–µí•´ì•¼ í•  ë‚˜ë§Œì˜ ë©”ëª¨ë¥¼ ì ì–´ë³´ì„¸ìš”.">{{myMemo}}</textarea>
                    <button type="submit" class="btn">ì €ì¥</button>
                </form>
            {% else %}
                <div class="memo-empty">
                    íŒ€ì„ ì„ íƒí•˜ë©´ ë©”ëª¨ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </div>
            {% endif %}
        </div>

        <div class="team-members">
            <h2>íŒ€ì› ëª©ë¡</h2>
            <ul class="member-list">
                {% if currentTeam %}
                    {% if teamMembers and teamMembers.length > 0 %}
                        {% for member in teamMembers %}
                        <li style="margin-bottom: 5px;">
                            {{member.nick}}
                            {% if member.id == user.id %}
                            <span style="font-weight:bold; color:#007bff;">(ë‚˜)</span>
                            {% endif %}
                        </li>
                        {% endfor %}
                    {% else %}
                        <li>ë©¤ë²„ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</li>
                    {% endif %}
                {% else %}
                    <li>íŒ€ì„ ì„ íƒí•˜ë©´ ë©¤ë²„ê°€ ë³´ì…ë‹ˆë‹¤.</li>
                {% endif %}
            </ul>
        </div>
    </div>

    <div id="eventModal" class="modal-overlay">
        <div class="modal-window">
            <div class="modal-header">
            <h2 id="modalTitle">ì¼ì • ì¶”ê°€</h2>
            <button type="button" onclick="closeModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            
            <form id="eventForm" onsubmit="return false;">
            <input type="hidden" id="eventId" name="id">
            <input type="hidden" id="teamId" name="teamId">
            
            <div class="modal-body">
                <label>ì¼ì • ë‚´ìš©</label>
                <input type="text" id="evtTitle" name="title" required placeholder="ì˜ˆ: íŒ€ íšŒì˜">

                <label>ì‹œì‘ ë‚ ì§œ</label>
                <input type="date" id="evtStart" name="start" required>

                <label>ì¢…ë£Œ ë‚ ì§œ</label>
                <input type="date" id="evtEnd" name="end" required>

                <label>ë‹´ë‹¹ì</label>
                <select id="evtAssignee" name="assigneeId">
                <option value=""> íŒ€ ì „ì²´ ì¼ì • (ë‹´ë‹¹ì ì—†ìŒ)</option>
                {% for member in teamMembers %}
                    <option value="{{member.id}}">{{member.nick}}</option>
                {% endfor %}
                </select>

                <label>ì§„í–‰ ìƒíƒœ</label>
                <div class="color-picker">
                    <div class="color-option selected" style="background:#dc3545;" onclick="selectColor(this, '#dc3545')" title="ì§„í–‰ì¤‘"></div>
                    <div class="color-option" style="background:#28a745;" onclick="selectColor(this, '#28a745')" title="ì™„ë£Œ"></div>
                </div>
                <input type="hidden" id="evtColor" name="color" value="#dc3545">

                <div style="display:flex; gap:10px; margin-top:10px;">
                <button type="button" class="btn btn-primary" id="saveBtn">ì €ì¥í•˜ê¸°</button>
                <button type="button" class="btn" id="deleteBtn" style="background:#dc3545; color:white; display:none;" onclick="deleteCurrentEvent()">ì‚­ì œ</button>
                </div>
            </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block right_content %}
    {% if user %}
        <ul class="todo-list" style="list-style:none; padding:0;">
            {% if myTodos and myTodos.length > 0 %}
                {% for todo in myTodos %}
                <li class="todo-item">
                    <div class="todo-date">
                        {{todo.dateStr}}
                    </div>
                    
                    <div class="todo-content">
                        <span class="status-dot" style="background-color: {{todo.color}};"></span>
                        
                        <span>{{todo.title}}</span>
                        
                        {% if not currentTeam %}
                            <span class="team-badge">({{todo.teamName}})</span>
                        {% endif %}
                    </div>
                </li>
                {% endfor %}
            {% else %}
                <li style="color: #999; padding: 20px 0; text-align: center;">
                    ì˜ˆì •ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.
                </li>
            {% endif %}
        </ul>
    {% else %}
        <p class="login-required">
            ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.
        </p>
    {% endif %}
{% endblock %}

{% block script %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
<script>
    const modal = document.getElementById('eventModal');
    const urlParams = new URLSearchParams(window.location.search);
    const currentTeamId = urlParams.get('teamId');

    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var dbEvents = JSON.parse(`{{ events | safe }}`); 

        var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ko',
        height: '100%',
        selectable: true,
        displayEventTime: false, // ì‹œê°„ ìˆ¨ê¸°ê¸°
        events: dbEvents,
        
        select: function(info) {
            if (!currentTeamId) { alert('íŒ€ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”!'); return; }
            openModal('add', info);
        },

        eventClick: function(info) {
            openModal('edit', info.event);
        }
        });
        calendar.render();
    });

    // ëª¨ë‹¬ ì—´ê¸°
    function openModal(mode, data) {
        modal.style.display = 'flex';
        document.getElementById('teamId').value = currentTeamId;
        
        // ìƒ‰ìƒ ì„ íƒ ì´ˆê¸°í™”
        document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));

        if (mode === 'add') {
            document.getElementById('modalTitle').innerText = 'ìƒˆ ì¼ì • ì¶”ê°€';
            document.getElementById('deleteBtn').style.display = 'none';
            
            document.getElementById('eventId').value = '';
            document.getElementById('evtTitle').value = '';
            document.getElementById('evtStart').value = data.startStr;
            document.getElementById('evtEnd').value = data.startStr;
            
            // ê¸°ë³¸ê°’: ë¹¨ê°•(ì§„í–‰ì¤‘)
            document.getElementById('evtColor').value = '#dc3545';
            document.querySelector('.color-option[title="ì§„í–‰ì¤‘"]').classList.add('selected');
            document.getElementById('evtAssignee').value = ""; // ë‹´ë‹¹ì ì´ˆê¸°í™”
        } else {
            document.getElementById('modalTitle').innerText = 'ì¼ì • ìˆ˜ì • / ì™„ë£Œ';
            document.getElementById('deleteBtn').style.display = 'block';

            document.getElementById('eventId').value = data.id;
            document.getElementById('evtTitle').value = data.title;
            
            const start = data.start ? data.start.toISOString().split('T')[0] : '';
            const end = data.end ? data.end.toISOString().split('T')[0] : start;

            document.getElementById('evtStart').value = start;
            document.getElementById('evtEnd').value = end;
            
            // ìƒ‰ìƒ ì„ íƒ ë³µêµ¬
            const color = data.backgroundColor;
            document.getElementById('evtColor').value = color;
            if(color === '#28a745') document.querySelectorAll('.color-option')[1].classList.add('selected');
            else document.querySelectorAll('.color-option')[0].classList.add('selected');

            // ë‹´ë‹¹ì ë³µêµ¬
            if (data.extendedProps && data.extendedProps.assigneeId) {
                document.getElementById('evtAssignee').value = data.extendedProps.assigneeId;
            } else {
                document.getElementById('evtAssignee').value = "";
            }
        }
    }

    function closeModal() {
        modal.style.display = 'none';
    }

    function selectColor(element, color) {
        document.getElementById('evtColor').value = color;
        document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
        element.classList.add('selected');
    }

    // ì €ì¥ ë²„íŠ¼ (REST API: POST/PATCH)
    document.getElementById('saveBtn').addEventListener('click', function() {
        const id = document.getElementById('eventId').value;
        const title = document.getElementById('evtTitle').value;
        const start = document.getElementById('evtStart').value;
        const end = document.getElementById('evtEnd').value;
        const color = document.getElementById('evtColor').value;
        const assigneeId = document.getElementById('evtAssignee').value;
        const teamId = document.getElementById('teamId').value;

        if(!title || !start) { alert('ë‚´ìš©ê³¼ ì‹œì‘ì¼ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }

        const payload = { id, title, start, end, color, assigneeId, teamId };
        
        // IDê°€ ìˆìœ¼ë©´ ìˆ˜ì •(PATCH), ì—†ìœ¼ë©´ ìƒì„±(POST)
        const method = id ? 'PATCH' : 'POST';
        
        fetch('/schedule', {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(res => {
            if(res.ok) location.reload(); // ì„±ê³µ ì‹œ ìƒˆë¡œê³ ì¹¨
            else alert('ì €ì¥ ì‹¤íŒ¨');
        })
        .catch(console.error);
    });

    // ì‚­ì œ ë²„íŠ¼ (REST API: DELETE)
    function deleteCurrentEvent() {
        const id = document.getElementById('eventId').value;
        if(confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            fetch('/schedule', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: id })
            })
            .then(res => {
                if(res.ok) location.reload();
                else alert('ì‚­ì œ ì‹¤íŒ¨');
            });
        }
    }
</script>
{% endblock %}